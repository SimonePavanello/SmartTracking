<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>SmartTrack | Inventario Dispositivi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-900 text-white min-h-screen">

<nav class="bg-slate-800 border-b border-slate-700 p-4 shadow-lg">
    <div class="container mx-auto flex justify-between items-center">
        <span class="text-xl font-bold text-blue-500"><i class="fas fa-truck-fast mr-2"></i>SMART TRACKING</span>
        <div class="flex items-center gap-6">
            <a th:href="@{/user/profile}" class="text-slate-400 hover:text-white transition text-sm">Profilo</a>
            <div th:if="${user.role == 'ADMIN'}" class="mb-4">
                <a th:href="@{/web/provision}" class="bg-blue-600 px-4 py-2 rounded">Nuovo Device</a>
            </div>
        </div>
    </div>
</nav>

<main class="container mx-auto mt-10 p-4">
    <div class="mb-8">
        <h1 class="text-3xl font-bold">Gestione Dispositivi IoT</h1>
        <p class="text-slate-400 mt-2">Monitoraggio e manutenzione della flotta sensori.</p>
    </div>

    <div class="bg-slate-800 rounded-2xl border border-slate-700 shadow-2xl overflow-hidden">
        <table class="w-full text-left border-collapse">
            <thead>
            <tr class="bg-slate-700/50 text-slate-300 uppercase text-xs font-bold tracking-wider">
                <th class="p-4">Nome dispositivo</th>
                <th class="p-4">Stato</th>
                <th class="p-4">Spedizione Associata</th>
                <th class="p-4">Configurazione</th>
                <th class="p-4">Api-KEY</th>
                <th class="p-4 text-right">Azioni</th>
            </tr>
            </thead>
            <tbody class="divide-y divide-slate-700">
            <tr th:each="device : ${devices}" class="hover:bg-slate-700/30 transition-colors group">
                <td class="p-4">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-slate-900 rounded flex items-center justify-center mr-3 text-blue-500">
                            <i class="fas fa-microchip"></i>
                        </div>
                        <span class="font-mono font-medium" th:text="${device.uuid}">SN-001</span>
                    </div>
                </td>
                <td class="p-4">
                    <span th:if="${device.status.name() == 'REGISTERED'}" class="bg-emerald-900/50 text-emerald-400 px-3 py-1 rounded-full text-xs font-bold border border-emerald-500/20">PRONTO</span>
                    <span th:if="${device.status.name() == 'ACTIVE'}" class="bg-blue-900/50 text-blue-400 px-3 py-1 rounded-full text-xs font-bold border border-blue-500/20">IN USO</span>
                    <span th:if="${device.status.name() == 'DECOMMISSIONED'}" class="bg-red-900/50 text-red-400 px-3 py-1 rounded-full text-xs font-bold border border-red-500/20">DISMESSO</span>
                </td>
                <td class="p-4">
                    <span th:text="${device.shipment != null ? device.shipment.code : 'Nessuna'}" class="text-slate-400 text-sm">SH-123</span>
                </td>
                <td class="p-4 text-sm text-slate-300">
                    <i class="fas fa-clock mr-1 text-slate-500"></i> <span th:text="${device.samplingIntervalSeconds}">60</span>s
                </td>
                <td class="p-4 font-mono text-[10px] text-blue-400">
                    <span th:id="'key-' + ${device.id}" th:text="${device.apiKey}">api-key-string</span>
                    <button th:onclick="'copyToClipboard(\'key-' + ${device.id} + '\')'"
                            class="ml-2 text-slate-500 hover:text-blue-400 transition-colors">
                        <i class="fas fa-copy"></i>
                    </button>
                </td>
                <td class="p-4 text-right">
                    <div class="flex justify-end gap-2">
                        <a th:href="@{/web/configDevice/{uuid}(uuid=${device.uuid})}" class="p-2 hover:bg-slate-600 rounded-lg text-slate-400 hover:text-white transition" title="Configura">
                            <i class="fas fa-cog"></i>
                        </a>
                        <form th:action="@{/web/decommission/{uuid}(uuid=${device.uuid})}" method="post" class="inline" onsubmit="return confirm('Sei sicuro di voler dismettere questo dispositivo?');">
                            <button type="submit" class="p-2 hover:bg-red-900/30 rounded-lg text-slate-400 hover:text-red-500 transition" title="Dismetti">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>

        <div th:if="${#lists.isEmpty(devices)}" class="p-20 text-center">
            <i class="fas fa-search text-5xl text-slate-700 mb-4"></i>
            <p class="text-slate-500">Nessun dispositivo trovato nel sistema.</p>
        </div>
    </div>
</main>
</body>
</html>

<script>
    function copyToClipboard(elementId) {
        // 1. Prendi il testo dallo span
        const text = document.getElementById(elementId).innerText;

        // 2. Usa l'API moderna per copiare
        navigator.clipboard.writeText(text).then(() => {
            // Opzionale: un feedback visivo veloce
            const btn = document.querySelector(`[onclick="copyToClipboard('${elementId}')"]`);
            const originalIcon = btn.innerHTML;

            btn.innerHTML = '<i class="fas fa-check text-emerald-500"></i>';
            setTimeout(() => {
                btn.innerHTML = originalIcon;
            }, 2000);

            console.log('API Key copiata: ' + text);
        }).catch(err => {
            console.error('Errore durante la copia: ', err);
        });
    }
</script>