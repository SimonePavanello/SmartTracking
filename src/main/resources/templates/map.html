<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>SmartTrack | Mappa Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col">

<nav class="bg-slate-800 border-b border-slate-700 p-4 shadow-lg">
    <div class="container mx-auto flex justify-between items-center">
        <span class="text-xl font-bold text-blue-500"><i class="fas fa-map-location-dot mr-2"></i>MONITORAGGIO LIVE</span>
        <a th:href="@{/user/profile}" class="text-slate-400 hover:text-white transition"><i class="fas fa-home mr-2"></i>Dashboard</a>
    </div>
</nav>

<div class="flex-1 flex overflow-hidden">
    <aside class="w-80 bg-slate-800 border-r border-slate-700 p-6 overflow-y-auto">
        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-6">Seleziona Spedizione</h3>
        <div class="space-y-3">
            <div th:each="ship : ${activeShipments}"
                 th:data-id="${ship.shipmentId}"
                 onclick="loadShipmentData(this.getAttribute('data-id'))"
                 class="p-4 bg-slate-900 rounded-xl border border-slate-700 hover:border-blue-500 cursor-pointer transition group">
                <span class="block font-bold text-blue-400 group-hover:text-blue-300" th:text="${ship.shipmentId}">SH-001</span>
                <span class="text-xs text-slate-500" th:text="${ship.destination}">Milano</span>
            </div>
        </div>
    </aside>

    <main id="map" class="flex-1 bg-slate-700"></main>
</div>

<script>
    // Inizializzazione Mappa centrata sull'Italia
    const map = L.map('map').setView([45.4642, 9.1900], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    let currentMarkers = [];
    let updateInterval;

    function loadShipmentData(shipmentId) {
        // Puliamo eventuali intervalli precedenti
        if(updateInterval) clearInterval(updateInterval);

        const fetchData = () => {
            fetch(`/api/tracking/shipment/${shipmentId}`)
                .then(response => response.json())
                .then(data => {
                    // Rimuoviamo i vecchi marker
                    currentMarkers.forEach(m => map.removeLayer(m));
                    currentMarkers = [];

                    if(data.length > 0) {
                        // Prendiamo l'ultimo punto ricevuto
                        const lastPoint = data[data.length - 1];
                        const marker = L.marker([lastPoint.latitude, lastPoint.longitude])
                            .addTo(map)
                            .bindPopup(`<b>${lastPoint.device.uid}</b><br>Temp: ${lastPoint.temperature}°C<br>Time: ${lastPoint.timestamp}`)
                            .openPopup();

                        currentMarkers.push(marker);
                        map.panTo([lastPoint.latitude, lastPoint.longitude]);
                    }
                });
        };

        fetchData();
        // Aggiorna automaticamente ogni 10 secondi
        updateInterval = setInterval(fetchData, 10000);
    }
</script>
</body>
</html>