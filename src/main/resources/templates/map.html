<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>SmartTrack | Mappa Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col">

<nav class="bg-slate-800 border-b border-slate-700 p-4 shadow-lg">
    <div class="container mx-auto flex justify-between items-center">
        <span class="text-xl font-bold text-blue-500"><i class="fas fa-map-location-dot mr-2"></i>MONITORAGGIO LIVE</span>
        <a th:href="@{/user/profile}" class="text-slate-400 hover:text-white transition"><i class="fas fa-home mr-2"></i>Dashboard</a>
    </div>
</nav>

<div class="flex-1 flex overflow-hidden">
    <aside class="w-80 bg-slate-800 border-r border-slate-700 p-6 overflow-y-auto">
        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-6">Seleziona Spedizione</h3>
        <div class="space-y-3">
            <div th:each="ship : ${activeShipments}"
                 th:data-id="${ship.shipmentId}"
                 onclick="loadShipmentData(this.getAttribute('data-id'))"
                 class="p-4 bg-slate-900 rounded-xl border border-slate-700 hover:border-blue-500 cursor-pointer transition group">
                <span class="block font-bold text-blue-400 group-hover:text-blue-300" th:text="${ship.shipmentId}">SH-001</span>
                <span class="text-xs text-slate-500" th:text="${ship.destination}">Milano</span>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col bg-slate-700">
        <div id="map" class="flex-1"></div>

        <div class="h-1/3 bg-slate-800 border-t border-slate-700 p-4 overflow-y-auto">
            <div class="flex justify-between items-center mb-3">
                <h4 class="text-xs font-bold text-blue-400 uppercase tracking-widest">
                    <i class="fas fa-list-ul mr-2"></i>Ultime Rilevazioni (Real-time)
                </h4>
                <span id="data-counter" class="text-[10px] text-slate-500 uppercase">Nessun dato</span>
            </div>

            <table class="w-full text-left text-xs border-collapse">
                <thead class="text-slate-500 sticky top-0 bg-slate-800">
                <tr class="border-b border-slate-700">
                    <th class="py-2">Orario</th>
                    <th class="py-2">Temp</th>
                    <th class="py-2">Umidità</th>
                    <th class="py-2">Posizione GPS</th>
                </tr>
                </thead>
                <tbody id="telemetry-body" class="text-slate-300 divide-y divide-slate-700/50">
                </tbody>
            </table>
        </div>
    </main>
</div>

<script>
    // Inizializzazione Mappa centrata sull'Italia
    const map = L.map('map').setView([45.4642, 9.1900], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    let currentMarkers = [];
    let updateInterval;

    function loadShipmentData(shipmentId) {
        // Puliamo eventuali intervalli precedenti
        if(updateInterval) clearInterval(updateInterval);

        const fetchData = () => {
            fetch(`/api/tracking/shipment/${shipmentId}`)
                .then(response => response.json())
                .then(data => {
                    // 1. Gestione Marker sulla Mappa
                    currentMarkers.forEach(m => map.removeLayer(m));
                    currentMarkers = [];

                    if(data.length > 0) {
                        const lastPoint = data[data.length - 1];
                        const marker = L.marker([lastPoint.latitude, lastPoint.longitude])
                            .addTo(map)
                            .bindPopup(`<b>Device: ${lastPoint.device.uid}</b><br>Ultima Temp: ${lastPoint.temperature}°C`)
                            .openPopup();

                        currentMarkers.push(marker);
                        map.panTo([lastPoint.latitude, lastPoint.longitude]);

                        // 2. Popolamento Tabella
                        const tableBody = document.getElementById('telemetry-body');
                        document.getElementById('data-counter').innerText = `Record totali: ${data.length}`;
                        tableBody.innerHTML = ''; // Pulisce la tabella precedente

                        // Mostriamo gli ultimi 10 record, dal più recente al più vecchio
                        data.slice().reverse().slice(0, 10).forEach(point => {
                            const date = new Date(point.timestamp).toLocaleTimeString();
                            const row = `
                        <tr class="hover:bg-slate-700/50 transition">
                            <td class="py-2 font-mono text-blue-400">${date}</td>
                            <td class="py-2 ${point.temperature > 25 ? 'text-red-500 font-bold' : ''}">
                                ${point.temperature}°C
                            </td>
                            <td class="py-2">${point.humidity}%</td>
                            <td class="py-2 text-slate-500 text-[10px]">
                                ${point.latitude.toFixed(4)}, ${point.longitude.toFixed(4)}
                            </td>
                        </tr>
                    `;
                            tableBody.innerHTML += row;
                        });
                    }
                });
        };

        fetchData();
        // Aggiorna automaticamente ogni 10 secondi
        updateInterval = setInterval(fetchData, 10000);
    }
</script>
</body>
</html>